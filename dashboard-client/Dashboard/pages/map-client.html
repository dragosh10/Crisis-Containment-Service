<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Client</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


</head>

<body>
<div class="sidebar">
    <button class="hamburger-toggle" id="sidebarToggle">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
    </button>
    
    <a href="#">
        <div class="icon-container active" id="map-icon">
            <img src="../icons/map.png" alt="Map Icon">
        </div>
    </a>
    <div class="icon-container" id="info-icon">
        <img src="../icons/info.png" alt="Info Icon">
    </div>
    
    <div class="icon-container" id="logout-icon" style="cursor: pointer;">
        <img src="../icons/logout.png" alt="Logout Icon">
    </div>
</div>
<div class="sidebar-secondary">
    <div class="section-header" data-section="filter">
        <h2>FILTER <i class="fas fa-chevron-down"></i></h2>
    </div>
    <div class="section-content" id="filterSection">
        <div class="filter-group">
            <label class="filter-label">
                <input type="checkbox" class="filter-bullet" id="locationFilter">
                Everything
            </label>

        </div>

        <div class="filter-group">
            <label class="filter-label">
                <input type="checkbox" class="filter-bullet" id="disasterFilter">
                Disaster Type
            </label>
            <select class="filter-input" id="disasterTypeSelect" disabled>
                <option value="" disabled selected>Type...</option>
                <option value="">All</option>
                <option value="flood">Flood</option>
                <option value="earthquake">Earthquake</option>
                <option value="wildfire">Wildfire</option>
                <option value="fire">Fire</option>
                <option value="heatwave">Heatwave</option>
                <option value="hurricane">Hurricane</option>
                <option value="hailstorm">Hail Storm</option>

                <option value="tsunami">Tsunami</option>
                <option value="volcanic eruption">Volcanic Eruption</option>
                <option value="landslide">Landslide</option>
                <option value="other">Other</option>

            </select>


            <div id="disasterCoordinatesSection" style="display: none; margin-top: 8px;">
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 4px;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" id="confirmDisasterPin" style="margin-right: 8px; transform: scale(1.2);">
                        <label for="confirmDisasterPin" style="margin: 0; font-weight: bold; font-size: 12px;">Confirm pin selection</label>
                    </div>
                    <div id="selected-disaster-info" style="display: none;">
                        <div id="selected-disaster-type" style="margin-bottom: 4px; font-size: 12px;"></div>
                        <div id="selected-disaster-coords" style="margin-bottom: 4px; font-size: 12px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">
                <input type="checkbox" class="filter-bullet" id="shelterFilter">
                Shelter
            </label>
            <select class="filter-input" id="shelterTypeFilter" disabled>
                <option value="all">All Shelters</option>
                <option value="permanent">Permanent</option>
                <option value="emergency">Emergency</option>
            </select>
        </div>
    </div>

    <div class="section-header" data-section="emergency">
        <h2>SET ALARMS<i class="fas fa-chevron-down"></i></h2>
    </div>
    <div class="section-content" id="emergencySection" style="display: none;">
        <div class="filter-group">
            <select class="filter-input" id="pinMethod">
                <option value="" disabled selected>How to set...</option>
                <option value="place-pin">Place Pin</option>
            </select>
        </div>

        <div class="filter-group" id="pinPlacementForm" style="display: none;">
            <div class="pin-fields">
                <div class="form-field">
                    <label>Latitude</label>
                    <input type="number" step="any" class="filter-input" id="lat" placeholder="Latitude" readonly>
                </div>
                <div class="form-field">
                    <label>Longitude</label>
                    <input type="number" step="any" class="filter-input" id="lng" placeholder="Longitude" readonly>
                </div>
                <div class="form-field">
                    <label>Name pin</label>
                    <input type="text" class="filter-input" id="description" placeholder="Home.." maxlength="15">
                    <div id="char-count" style="font-size: 12px; color: #ccc; margin-top: 4px;">15 characters remaining</div>
                    <div id="description-error" style="font-size: 12px; color: #ff4444; margin-top: 4px; display: none;"></div>
                </div>
            </div>


           



            <button class="filter-input submit-btn" id="addPinButton" style="background-color: #9E1717; color: white; cursor: pointer;">
                Add Alarm Pin
            </button>
            <div id="form-message" style="color: white; text-align: center; margin-top: 10px;"></div>
        </div>
    </div>

    <div class="section-header" data-section="protips" style="display: none;">
        <h2>PRO TIPS <i class="fas fa-chevron-down"></i></h2>
    </div>
    <div class="section-content" id="protipsSection" style="display: none;">
        <div class="pro-tips-container">
            <div class="emergency-illustration">
                <img src="../../../public/images/firefighter.png" alt="Emergency Illustration" class="emergency-image" id="tipImage">
            </div>
            <div class="tips-content">
                <div class="tips-title" id="tipTitle">Earthquake Preparedness</div>
                <div class="tip-text" id="tipText">
                    <p><strong>Drop, Cover, and Hold On</strong> - The best protection during an earthquake.</p>
                    <p><strong>Stay away from glass</strong> - Windows and mirrors can shatter.</p>
                    <p><strong>Have an emergency kit</strong> - Water, food, flashlight, and first aid supplies.</p>
                </div>
                <div class="navigation-arrows">
                    <button class="nav-arrow" onclick="changeTip(-1)">‹</button>
                    <button class="nav-arrow" onclick="changeTip(1)">›</button>
                </div>
            </div>
        </div>
    </div>

</div>
<div class="main-content">
    <div id="map"></div>
    <div class="coordinates-display">
        Click on map to set coordinates
    </div>
</div>
<script src="prevention.js"></script>
<script src="earthquakeApi.js"></script>
<script src="fires.js"></script>
<script src="calamities_c.js"></script>
<script src="shelters_c.js"></script>
<script src="earthquake.js"></script>
<script src="floods.js"></script>
<script src="alarms.js"></script>
<script src="filter.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>


<script>

    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);


    loadEarthquakes(map);
    loadFires(map);
    loadCalamities(map);
    loadFloods(map);


    if (typeof loadShelters === 'function') {
        loadShelters(map, createCustomIcon);
    }


    if (typeof initializeClientAlarms === 'function') {
        // Initialize client alarms asynchronously
        initializeClientAlarms(map, createCustomIcon).catch(error => {
            console.error('Error initializing client alarms:', error);
        });
    }

    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
                <div class="legend-header" style="background: rgba(0,0,0,0.8); padding: 8px; border-radius: 4px; color: white; margin-bottom: 4px;">
                    <strong>Disaster Types .</strong>

                    <button id="legend-toggle" style="float: right; background: #9E1717; border: 1px solid #9E1717; color: white; padding: 2px 6px; font-size: 12px; cursor: pointer; border-radius: 3px;">Hide</button>
                </div>
                <div id="legend-content" style="background: rgba(0,0,0,0.8); padding: 8px; border-radius: 4px; color: white;">
                    <div><i class="fas fa-house-crack" style="color: #ff4444;"></i> Earthquake</div>
                    <div><i class="fas fa-fire" style="color: #ff8800;"></i> Fire</div>
                    <div><i class="fas fa-water" style="color: #0099cc;"></i> Flood</div>

                    <div><i class="fas fa-sun" style="color: #ffd700;"></i> Heatwave</div>
                    <div><i class="fas fa-wind" style="color: #8b4513;"></i> Hurricane</div>
                    <div><i class="fas fa-cloud-meatball" style="color: #4169e1;"></i> Hailstorm</div>
                    <div><i class="fas fa-tree" style="color: #ff6600;"></i> Wildfire</div>

                    <div><i class="fas fa-water" style="color: #006699;"></i> Tsunami</div>
                    <div><i class="fas fa-mountain" style="color: #cc0000;"></i> Volcanic Eruption</div>
                    <div><i class="fas fa-mountain" style="color: #8b4513;"></i> Landslide</div>
                    <div><i class="fas fa-exclamation-triangle" style="color: #ffbb33;"></i> Other</div>
                    <hr style="border-color: #555; margin: 8px 0;">
                    <div><i class="fas fa-home" style="color: #28a745;"></i> Shelter</div>
                    <div><i class="fas fa-route" style="color: #ffc107;"></i> Escape Route</div>
                    <div><i class="fas fa-map-pin" style="color: #28a745;"></i> Your Alarm Pins</div>
                </div>
            `;
        return div;
    };
    legend.addTo(map);


    map.on('legendadd', function() {
        const toggleBtn = document.getElementById('legend-toggle');
        const legendContent = document.getElementById('legend-content');
        let isVisible = true;

        toggleBtn.addEventListener('click', function() {
            if (isVisible) {
                legendContent.style.display = 'none';
                toggleBtn.textContent = 'Show';
            } else {
                legendContent.style.display = 'block';
                toggleBtn.textContent = 'Hide';
            }
            isVisible = !isVisible;
        });
    });

    setTimeout(() => {
        map.fire('legendadd');
    }, 100);

    map.setView([45.9432, 24.9668], 7);
    document.querySelector('[data-section="filter"]').classList.add('active');
    document.getElementById('filterSection').style.display = 'block';

    // Logout functionality
    document.getElementById('logout-icon').addEventListener('click', function() {
        if (confirm('Are you sure you want to log out?')) {
            fetch('/api/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    } else {
                        console.error('Logout failed');
                        // Redirect anyway in case of error
                        window.location.href = '/';
                    }
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    // Redirect anyway in case of error
                    window.location.href = '/';
                });
        }
    });

    // Filter functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Disaster filter
        const disasterFilterCheckbox = document.getElementById('disasterFilter');
        const disasterTypeSelect = document.getElementById('disasterTypeSelect');
        if (disasterFilterCheckbox && disasterTypeSelect) {
            disasterFilterCheckbox.addEventListener('change', function() {
                disasterTypeSelect.disabled = !this.checked;
            });
            // Inițial dezactivez
            disasterTypeSelect.disabled = !disasterFilterCheckbox.checked;
        }
        // Shelter filter
        const shelterFilterCheckbox = document.getElementById('shelterFilter');
        const shelterTypeSelect = document.getElementById('shelterTypeFilter');
        if (shelterFilterCheckbox && shelterTypeSelect) {
            shelterFilterCheckbox.addEventListener('change', function() {
                shelterTypeSelect.disabled = !this.checked;
            });
            // Inițial dezactivez
            shelterTypeSelect.disabled = !shelterFilterCheckbox.checked;
        }
    });

    // Sidebar toggle functionality
    function toggleSidebar() {
        const body = document.body;
        const mainContent = document.querySelector('.main-content');
        
        body.classList.toggle('sidebar-collapsed');
        
        // Update map size after sidebar toggle
        setTimeout(() => {
            map.invalidateSize();
        }, 300); // Match the CSS transition duration
    }
    
    // Add event listener for hamburger
    document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);

    // Auto-collapse sidebar and manage legend on mobile
    function handleMobileLayout() {
        const body = document.body;
        const legend = document.querySelector('.legend');
        const legendContent = document.getElementById('legend-content');
        const legendToggle = document.getElementById('legend-toggle');
        
        if (window.innerWidth <= 768) {
            // Auto-collapse sidebar on mobile
            body.classList.add('sidebar-collapsed');
            
            // Keep legend toggle but start collapsed on mobile
            if (legend) {
                legend.style.display = 'block';
            }
            if (legendContent) {
                legendContent.style.display = 'none';
            }
            if (legendToggle) {
                legendToggle.textContent = 'Show';
            }
        } else {
            // Show legend expanded on larger screens
            if (legend) {
                legend.style.display = 'block';
            }
            if (legendContent) {
                legendContent.style.display = 'block';
            }
            if (legendToggle) {
                legendToggle.textContent = 'Hide';
            }
        }
        
        // Update map size
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    }

    // Call on load and resize
    handleMobileLayout();
    window.addEventListener('resize', handleMobileLayout);

    // Pro tips functionality
    const tips = [
        {
            title: "Earthquake Preparedness",
            image: "../../../public/images/firefighter.png",
            content: `
                <p><strong>Drop, Cover, and Hold On</strong> - The best protection during an earthquake.</p>
                <p><strong>Stay away from glass</strong> - Windows and mirrors can shatter.</p>
                <p><strong>Have an emergency kit</strong> - Water, food, flashlight, and first aid supplies.</p>
            `
        },
        {
            title: "Fire Prevention",
            image: "../../../public/images/fire.png",
            content: `
                <p><strong>Install smoke detectors</strong> - Check batteries regularly and test monthly.</p>
                <p><strong>Keep fire extinguishers</strong> - Place them in kitchen, garage, and key areas.</p>
                <p><strong>Plan escape routes</strong> - Practice fire drills with your family.</p>
                <p><strong>Safe cooking habits</strong> - Never leave cooking unattended.</p>
            `
        },
        {
            title: "Flood Preparation",
            image: "../../../public/images/flood.png",
            content: `
                <p><strong>Know your flood risk</strong> - Check local flood maps and evacuation routes.</p>
                <p><strong>Emergency kit ready</strong> - Include waterproof containers and supplies.</p>
                <p><strong>Avoid flooded roads</strong> - Turn around, don't drown. 6 inches can knock you down.</p>
                <p><strong>Move to higher ground</strong> - If flooding threatens, evacuate immediately.</p>
            `
        }
    ];

    let currentTipIndex = 0;

    function changeTip(direction) {
        currentTipIndex += direction;
        if (currentTipIndex >= tips.length) {
            currentTipIndex = 0;
        } else if (currentTipIndex < 0) {
            currentTipIndex = tips.length - 1;
        }
        updateTipDisplay();
    }

    function updateTipDisplay() {
        const currentTip = tips[currentTipIndex];
        document.getElementById('tipTitle').textContent = currentTip.title;
        document.getElementById('tipText').innerHTML = currentTip.content;
        document.getElementById('tipImage').src = currentTip.image;
    }

    // Info icon functionality
    document.getElementById('info-icon').addEventListener('click', function() {
        const body = document.body;
        const filterHeader = document.querySelector('[data-section="filter"]');
        const filterSection = document.getElementById('filterSection');
        const emergencyHeader = document.querySelector('[data-section="emergency"]');
        const emergencySection = document.getElementById('emergencySection');
        const protipsHeader = document.querySelector('[data-section="protips"]');
        const protipsSection = document.getElementById('protipsSection');
        const mapIcon = document.getElementById('map-icon');
        const infoIcon = document.getElementById('info-icon');

        // Ensure sidebar is open
        body.classList.remove('sidebar-collapsed');

        // Hide filter and emergency sections
        filterHeader.style.display = 'none';
        filterSection.style.display = 'none';
        emergencyHeader.style.display = 'none';
        emergencySection.style.display = 'none';

        // Show pro tips section
        protipsHeader.style.display = 'block';
        protipsSection.style.display = 'block';
        protipsHeader.classList.add('active');

        // Update icon states
        mapIcon.classList.remove('active');
        infoIcon.classList.add('active');

        // Initialize first tip
        updateTipDisplay();

        // Update map size after sidebar changes
        setTimeout(() => {
            map.invalidateSize();
        }, 300);
    });

    // Map icon functionality - show map sections and hide pro tips
    document.getElementById('map-icon').addEventListener('click', function(e) {
        e.preventDefault();
        
        const body = document.body;
        const filterHeader = document.querySelector('[data-section="filter"]');
        const filterSection = document.getElementById('filterSection');
        const emergencyHeader = document.querySelector('[data-section="emergency"]');
        const emergencySection = document.getElementById('emergencySection');
        const protipsHeader = document.querySelector('[data-section="protips"]');
        const protipsSection = document.getElementById('protipsSection');
        const mapIcon = document.getElementById('map-icon');
        const infoIcon = document.getElementById('info-icon');

        // Check if we're currently showing pro tips
        if (protipsSection.style.display === 'block') {
            // Hide pro tips
            protipsHeader.style.display = 'none';
            protipsSection.style.display = 'none';
            protipsHeader.classList.remove('active');

            // Show map sections
            filterHeader.style.display = 'block';
            filterSection.style.display = 'block';
            emergencyHeader.style.display = 'block';
            filterHeader.classList.add('active');

            // Update icon states
            infoIcon.classList.remove('active');
            mapIcon.classList.add('active');

            // Ensure sidebar is open when switching to map view
            body.classList.remove('sidebar-collapsed');
        } else {
            // If not showing pro tips, just toggle sidebar
            toggleSidebar();
        }

        // Update map size after changes
        setTimeout(() => {
            map.invalidateSize();
        }, 300);
    });


</script>
</body>

</html>